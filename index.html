<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Äî –¥–æ —Ç—Ä–∏–ª–ª–∏–æ–Ω–∞</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      padding: 20px;
    }

    .calculator {
      width: 100%;
      max-width: 420px;
      background: #0f172a;
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
      overflow: hidden;
    }

    .display {
      padding: 36px 24px;
      text-align: right;
      background: #070c16;
      color: #f1f5f9;
    }

    .prev-operand {
      font-size: 1.3rem;
      opacity: 0.7;
      min-height: 1.5em;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .current-operand {
      font-size: 2.9rem;
      font-weight: 600;
      margin-top: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: #1e293b;
    }

    button {
      border: none;
      outline: none;
      background: #1e293b;
      color: white;
      font-size: 1.45rem;
      padding: 22px 0;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    button:active {
      background: #334155;
      transform: scale(0.97);
    }

    button.operator { background: #4f46e5; }
    button.equals { 
      background: #10b981; 
      grid-column: span 2;
    }
    button.clear { background: #ef4444; }
    button.delete { background: #f97316; }

    .mic-btn {
      grid-column: span 4;
      background: #0ea5e9;
      font-size: 1.35rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-weight: 600;
    }

    .mic-btn.listening { background: #f97316; }
    .mic-btn.allowed { background: #10b981; }

    .status {
      padding: 14px;
      text-align: center;
      font-size: 0.95rem;
      color: #94a8c1;
      background: #070c16;
      border-top: 1px solid #1e293b;
    }

    .examples {
      padding: 16px 20px;
      background: rgba(0,0,0,0.2);
      font-size: 0.85rem;
      color: #cbd5e1;
    }

    .examples h4 {
      margin-bottom: 8px;
      color: #e2e8f0;
    }

    .examples code {
      background: rgba(255,255,255,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>
<body>

  <div class="calculator">
    <div class="display">
      <div class="prev-operand" id="prev"></div>
      <div class="current-operand" id="current">0</div>
    </div>

    <div class="buttons">
      <button class="clear" onclick="clearAll()">C</button>
      <button class="delete" onclick="deleteChar()">‚å´</button>
      <button class="operator" onclick="appendOperator('√∑')">√∑</button>
      <button class="operator" onclick="appendOperator('(')">(</button>

      <button onclick="appendNumber('7')">7</button>
      <button onclick="appendNumber('8')">8</button>
      <button onclick="appendNumber('9')">9</button>
      <button class="operator" onclick="appendOperator(')')">)</button>

      <button onclick="appendNumber('4')">4</button>
      <button onclick="appendNumber('5')">5</button>
      <button onclick="appendNumber('6')">6</button>
      <button class="operator" onclick="appendOperator('√ó')">√ó</button>

      <button onclick="appendNumber('1')">1</button>
      <button onclick="appendNumber('2')">2</button>
      <button onclick="appendNumber('3')">3</button>
      <button class="operator" onclick="appendOperator('‚àí')">‚àí</button>

      <button onclick="appendNumber('0')">0</button>
      <button onclick="appendNumber('.')">.</button>
      <button class="equals" onclick="calculate()">=</button>
      <button class="operator" onclick="appendOperator('+')">+</button>

      <button class="mic-btn" id="micBtn" onclick="toggleSpeech()">
        <span>üé§</span>
        <span id="micLabel">–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</span>
      </button>
    </div>

    <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞—Å—á—ë—Ç—É</div>

    <div class="examples">
      <h4>üó£Ô∏è –ì–æ–≤–æ—Ä–∏—Ç–µ —Ç–∞–∫:</h4>
      <p><code>2 –º–ª–Ω + 3 –º–ª–Ω</code> ‚Üí 5 000 000</p>
      <p><code>1.5 –º–ª—Ä–¥ –º–∏–Ω—É—Å 500 –º–ª–Ω</code> ‚Üí 1 000 000 000</p>
      <p><code>—Ç—Ä–∏—Å—Ç–∞ —Ç—ã—Å—è—á —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ –¥–≤–∞</code> ‚Üí 600 000</p>
    </div>
  </div>

  <script>
    // === –í–°–¢–†–û–ï–ù–ù–ê–Ø –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ü–ê–†–°–ò–ù–ì–ê –ß–ò–°–ï–õ (–¥–æ 10^18) ===
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –º–ª–Ω, –º–ª—Ä–¥, —Ç—ã—Å, –º, –∫ ‚Äî –∏ –ø–æ–ª–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    const NumberParser = {
      // –°–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ –ø–æ–ª–Ω—ã–µ —Ñ–æ—Ä–º—ã
      multipliers: {
        '—Ç—ã—Å—è—á–∞': 1e3, '—Ç—ã—Å—è—á–∏': 1e3, '—Ç—ã—Å—è—á': 1e3,
        '—Ç—ã—Å': 1e3, '—Ç': 1e3,
        '–º–∏–ª–ª–∏–æ–Ω': 1e6, '–º–∏–ª–ª–∏–æ–Ω–∞': 1e6, '–º–∏–ª–ª–∏–æ–Ω–æ–≤': 1e6,
        '–º–ª–Ω': 1e6, '–º': 1e6,
        '–º–∏–ª–ª–∏–∞—Ä–¥': 1e9, '–º–∏–ª–ª–∏–∞—Ä–¥–∞': 1e9, '–º–∏–ª–ª–∏–∞—Ä–¥–æ–≤': 1e9,
        '–º–ª—Ä–¥': 1e9, '–º–ª—Ä': 1e9,
        '—Ç—Ä–∏–ª–ª–∏–æ–Ω': 1e12, '—Ç—Ä–∏–ª–ª–∏–æ–Ω–∞': 1e12, '—Ç—Ä–∏–ª–ª–∏–æ–Ω–æ–≤': 1e12,
        '—Ç–ª–Ω': 1e12
      },

      // –ë–∞–∑–æ–≤—ã–µ —á–∏—Å–ª–∞
      units: {
        '–Ω–æ–ª—å': 0, '–æ–¥–∏–Ω': 1, '–¥–≤–∞': 2, '—Ç—Ä–∏': 3, '—á–µ—Ç—ã—Ä–µ': 4, '–ø—è—Ç—å': 5,
        '—à–µ—Å—Ç—å': 6, '—Å–µ–º—å': 7, '–≤–æ—Å–µ–º—å': 8, '–¥–µ–≤—è—Ç—å': 9,
        '–¥–µ—Å—è—Ç—å': 10, '–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å': 11, '–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å': 12, '—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å': 13,
        '—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å': 14, '–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å': 15, '—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å': 16,
        '—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å': 17, '–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å': 18, '–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å': 19
      },

      tens: {
        '–¥–≤–∞–¥—Ü–∞—Ç—å': 20, '—Ç—Ä–∏–¥—Ü–∞—Ç—å': 30, '—Å–æ—Ä–æ–∫': 40, '–ø—è—Ç—å–¥–µ—Å—è—Ç': 50,
        '—à–µ—Å—Ç—å–¥–µ—Å—è—Ç': 60, '—Å–µ–º—å–¥–µ—Å—è—Ç': 70, '–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç': 80, '–¥–µ–≤—è–Ω–æ—Å—Ç–æ': 90
      },

      hundreds: {
        '—Å—Ç–æ': 100, '–¥–≤–µ—Å—Ç–∏': 200, '—Ç—Ä–∏—Å—Ç–∞': 300, '—á–µ—Ç—ã—Ä–µ—Å—Ç–∞': 400,
        '–ø—è—Ç—å—Å–æ—Ç': 500, '—à–µ—Å—Ç—å—Å–æ—Ç': 600, '—Å–µ–º—å—Å–æ—Ç': 700,
        '–≤–æ—Å–µ–º—å—Å–æ—Ç': 800, '–¥–µ–≤—è—Ç—å—Å–æ—Ç': 900
      },

      // –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä
      parse(text) {
        if (!text) return 0;
        text = text.toLowerCase().replace(/—ë/g, '–µ');

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –¥—Ä–æ–±–µ–π: "1.5 –º–ª–Ω"
        const floatMatch = text.match(/(-?\d+(?:\.\d+)?)(?:\s*(–º–ª–Ω|–º–ª—Ä–¥|—Ç—ã—Å|–º|—Ç|–∫))?/);
        if (floatMatch) {
          let num = parseFloat(floatMatch[1]);
          const unit = floatMatch[2];
          if (unit && this.multipliers[unit]) {
            num *= this.multipliers[unit];
          }
          return num;
        }

        // –°–ª–æ–≤–∞ ‚Üí —á–∏—Å–ª–∞
        let total = 0;
        let current = 0;

        const words = text.split(/\s+/).filter(w => w);

        for (let word of words) {
          // –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
          word = word.replace(/[^\w–∞-—è—ë]/gi, '');

          if (this.hundreds[word]) {
            current += this.hundreds[word];
          } else if (this.tens[word]) {
            current += this.tens[word];
          } else if (this.units[word] !== undefined) {
            current += this.units[word];
          } else if (this.multipliers[word]) {
            if (current === 0) current = 1;
            total += current * this.multipliers[word];
            current = 0;
          }
        }

        total += current;
        return total;
      }
    };

    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let currentOperand = '0';
    let previousOperand = '';
    let resetOnNextInput = false;
    
    const prevElement = document.getElementById('prev');
    const currentElement = document.getElementById('current');
    const statusElement = document.getElementById('status');
    const micBtn = document.getElementById('micBtn');
    const micLabel = document.getElementById('micLabel');
    
    let recognition;
    let isListening = false;
    let permissionState = 'prompt'; // 'granted', 'denied', 'prompt'

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞
    async function checkMicPermission() {
      try {
        if (navigator.permissions) {
          const result = await navigator.permissions.query({ name: 'microphone' });
          permissionState = result.state;
          result.onchange = () => {
            permissionState = result.state;
            updateMicUI();
          };
          return result.state;
        }
        // Fallback: –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop());
        permissionState = 'granted';
        return 'granted';
      } catch (e) {
        permissionState = 'denied';
        return 'denied';
      }
    }

    function updateMicUI() {
      if (permissionState === 'granted') {
        micBtn.classList.add('allowed');
        micBtn.classList.remove('listening');
        micLabel.textContent = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥';
      } else if (permissionState === 'denied') {
        micBtn.style.opacity = '0.6';
        micLabel.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–ø—Ä–µ—â—ë–Ω';
      } else {
        micBtn.style.opacity = '1';
        micBtn.classList.remove('allowed', 'listening');
        micLabel.textContent = '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥';
      }
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø ===
    function initSpeech() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        statusElement.textContent = '‚ö†Ô∏è –†–µ—á—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        micBtn.disabled = true;
        return false;
      }

      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'ru-RU';

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        processSpeech(transcript);
      };

      recognition.onerror = (event) => {
        console.error('Speech error:', event.error);
        if (event.error === 'not-allowed') {
          permissionState = 'denied';
          updateMicUI();
          statusElement.textContent = 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.';
        } else {
          statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞: ${event.error}`;
        }
        stopListening();
      };

      recognition.onend = () => {
        if (isListening) {
          setTimeout(() => {
            if (isListening && permissionState === 'granted') {
              recognition.start();
            }
          }, 300);
        }
      };

      return true;
    }

    async function toggleSpeech() {
      if (!recognition && !initSpeech()) return;

      if (permissionState !== 'granted') {
        try {
          // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          stream.getTracks().forEach(track => track.stop());
          permissionState = 'granted';
          updateMicUI();
        } catch (e) {
          permissionState = 'denied';
          updateMicUI();
          return;
        }
      }

      if (isListening) {
        stopListening();
      } else {
        startListening();
      }
    }

    function startListening() {
      isListening = true;
      micBtn.classList.add('listening');
      micBtn.classList.remove('allowed');
      micLabel.textContent = '–°–ª—É—à–∞—é...';
      statusElement.textContent = 'üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ (–Ω–∞–ø—Ä.: "2 –º–ª–Ω + 3 –º–ª–Ω")';
      
      try {
        recognition.start();
      } catch (e) {
        statusElement.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        stopListening();
      }
    }

    function stopListening() {
      isListening = false;
      micBtn.classList.remove('listening');
      if (permissionState === 'granted') {
        micBtn.classList.add('allowed');
        micLabel.textContent = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥';
      }
      if (recognition) recognition.stop();
    }

    // === –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ß–ò ===
    function processSpeech(text) {
      statusElement.textContent = `üó£Ô∏è "${text}"`;
      
      // –ó–∞–º–µ–Ω–∞ —Å–ª–æ–≤-–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ —Å–∏–º–≤–æ–ª—ã
      let expr = text
        .toLowerCase()
        .replace(/–ø–ª—é—Å|—Å–ª–æ–∂–∏—Ç—å|–ø—Ä–∏–±–∞–≤–∏—Ç—å|–∏|\+/g, '+')
        .replace(/–º–∏–Ω—É—Å|–≤—ã—á–µ—Å—Ç—å|–æ—Ç–Ω—è—Ç—å|–±–µ–∑|\-/g, '-')
        .replace(/—É–º–Ω–æ–∂–∏—Ç—å\s+–Ω–∞|—É–º–Ω–æ–∂—å\s+–Ω–∞|\*|√ó|—É–º–Ω–æ–∂–∏—Ç—å|—É–º–Ω–æ–∂—å/g, '*')
        .replace(/—Ä–∞–∑–¥–µ–ª–∏—Ç—å\s+–Ω–∞|—Ä–∞–∑–¥–µ–ª–∏\s+–Ω–∞|–ø–æ–¥–µ–ª–∏—Ç—å\s+–Ω–∞|–ø–æ–¥–µ–ª–∏\s+–Ω–∞|\/|√∑/g, '/')
        .replace(/—Ä–∞–≤–Ω–æ|—Ä–∞–≤–Ω—è–µ—Ç—Å—è|–ø–æ–ª—É—á–∏—Ç—Å—è|—Å–∫–æ–ª—å–∫–æ\s+–±—É–¥–µ—Ç|—Ä–µ–∑—É–ª—å—Ç–∞—Ç|=/g, '')
        .replace(/\s+/g, ' ')
        .trim();

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω—ã: —á–∏—Å–ª–∞ (—Å –º–Ω/–º–ª—Ä–¥) –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
      const tokens = [];
      const parts = expr.split(/([+\-*/()])/).filter(p => p.trim() !== '');

      for (let part of parts) {
        part = part.trim();
        if (!part) continue;

        // –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
        if (['+', '-', '*', '/', '(', ')'].includes(part)) {
          tokens.push(part);
          continue;
        }

        // –ß–∏—Å–ª–∞: "2 –º–ª–Ω", "—Ç—Ä–∏ –º–∏–ª–ª–∏–æ–Ω–∞", "1.5"
        try {
          const num = NumberParser.parse(part);
          if (!isNaN(num) && isFinite(num)) {
            tokens.push(num.toString());
          }
        } catch (e) {
          console.warn('–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', part);
        }
      }

      const finalExpr = tokens.join(' ');

      // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ
      try {
        if (finalExpr && finalExpr.match(/[\d+\-*/()]/)) {
          // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
          const safeExpr = finalExpr
            .replace(/‚àí/g, '-')
            .replace(/√ó/g, '*')
            .replace(/√∑/g, '/');
          
          const result = Function(`"use strict"; return (${safeExpr})`)();
          
          if (typeof result === 'number' && isFinite(result)) {
            previousOperand = `${safeExpr} =`;
            currentOperand = String(result);
            updateDisplay();
            statusElement.textContent = `‚úÖ ${finalExpr} = ${formatNumber(currentOperand)}`;
          } else {
            throw new Error('Invalid result');
          }
        } else {
          throw new Error('No valid expression');
        }
      } catch (e) {
        currentOperand = '0';
        updateDisplay();
        statusElement.textContent = `‚ùì –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å: "${text}"`;
      }

      stopListening();
    }

    // === –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† ===
    function updateDisplay() {
      currentElement.textContent = formatNumber(currentOperand);
      prevElement.textContent = previousOperand;
    }

    function formatNumber(num) {
      if (num === '') return '0';
      let n = parseFloat(num);
      if (isNaN(n)) return num;
      
      if (Number.isInteger(n)) {
        return n.toLocaleString('ru-RU');
      }
      return n.toLocaleString('ru-RU', { maximumFractionDigits: 6 });
    }

    function appendNumber(number) {
      if (currentOperand === '0' || resetOnNextInput) {
        currentOperand = number;
        resetOnNextInput = false;
      } else {
        currentOperand += number;
      }
      updateDisplay();
    }

    function appendOperator(op) {
      if (currentOperand === '' && op !== '(') return;
      if (previousOperand !== '' && !resetOnNextInput) {
        calculate();
      }
      if (op === '(' || op === ')') {
        currentOperand += op;
        resetOnNextInput = false;
      } else {
        previousOperand = `${currentOperand} ${op}`;
        resetOnNextInput = true;
      }
      updateDisplay();
    }

    function calculate() {
      let computation;
      const prevStr = previousOperand.split(' ')[0];
      const current = parseFloat(currentOperand);
      const prev = parseFloat(prevStr);
      
      if (isNaN(prev) || isNaN(current)) {
        try {
          const expr = (previousOperand + ' ' + currentOperand)
            .replace(/‚àí/g, '-').replace(/√ó/g, '*').replace(/√∑/g, '/');
          const result = Function(`"use strict"; return (${expr})`)();
          currentOperand = String(result);
          previousOperand = '';
          updateDisplay();
          return;
        } catch (e) {
          return;
        }
      }

      const op = previousOperand.split(' ')[1];
      switch (op) {
        case '+': computation = prev + current; break;
        case '‚àí': computation = prev - current; break;
        case '√ó': computation = prev * current; break;
        case '√∑': computation = prev / current; break;
        default: return;
      }

      currentOperand = String(computation);
      previousOperand = '';
      resetOnNextInput = true;
      updateDisplay();
    }

    function clearAll() {
      currentOperand = '0';
      previousOperand = '';
      resetOnNextInput = false;
      updateDisplay();
      statusElement.textContent = '–û—á–∏—â–µ–Ω–æ';
    }

    function deleteChar() {
      if (currentOperand.length === 1 || (currentOperand.length === 2 && currentOperand.startsWith('-'))) {
        currentOperand = '0';
      } else {
        currentOperand = currentOperand.slice(0, -1);
      }
      updateDisplay();
    }

    // === –ó–ê–ü–£–°–ö ===
    updateDisplay();
    checkMicPermission().then(updateMicUI);
  </script>

</body>
</html>